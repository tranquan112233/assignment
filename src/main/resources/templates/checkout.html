<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head class="">
    <meta charset="UTF-8">
    <title>Thanh toán - PC Store</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        :root{ --brand:#dc3545; }
        .brand { color:var(--brand) }
        .btn-brand { background:var(--brand); color:#fff }
        .btn-brand:hover { filter:brightness(.95); color:#fff }
        .border-muted{ border-color:#e5e7eb !important }
        .shadow-s { box-shadow: 0 6px 18px rgba(0,0,0,.06); }
        .summary-img{ width:48px;height:48px;object-fit:cover;border-radius:.5rem;border:1px solid #eee }
        .muted{ color:#6B7280 }
        .tiny { font-size:.875rem }
        /* nếu header sticky/fixed, tránh đè nội dung */
        body { padding-top: 76px; }
    </style>
</head>
<body class="bg-white" >
<div th:replace="~{layout/header :: header(danhMucs=${danhMucs})}"></div>

<!-- Header: TRUYỀN danh mục vào fragment -->

<div class="container py-4">
    <div class="row g-4">
        <!-- =================== FORM =================== -->
        <div class="col-lg-7">
            <h4 class="mb-3">Thông tin liên hệ</h4>

            <form method="post" th:action="@{/checkout}">
                <input type="hidden" name="userId" th:value="${userId}">
                <!-- buy-now mode -->
                <input th:if="${buyNow}" type="hidden" name="buyNow" th:value="${bnProductId}">
                <input th:if="${buyNow}" type="hidden" name="qty" th:value="${bnQty}">

                <div class="mb-3">
                    <input type="email" class="form-control" name="email" placeholder="Email" required>
                </div>

                <h4 class="mt-4 mb-3">Giao hàng</h4>
                <div class="row g-2">
                    <div class="col-md-6"><input class="form-control" name="ho"  placeholder="Họ" required></div>
                    <div class="col-md-6"><input class="form-control" name="ten" placeholder="Tên" required></div>
                    <div class="col-12">
                        <input class="form-control" name="diaChi"
                               placeholder="Địa chỉ (Số nhà, đường, phường/xã, quận/huyện, tỉnh/thành, mã bưu chính)"
                               th:value="${defaultAddr != null} ? ${defaultAddr.diaChiChiTiet} : ''" required>
                    </div>
                    <div class="col-md-6"><input class="form-control" name="dienThoai" placeholder="Điện thoại" required></div>
                </div>

                <div class="mt-4">
                    <h4 class="mb-3">Phương thức vận chuyển</h4>
                    <div class="form-check border rounded-3 p-3 border-muted shadow-s">
                        <input class="form-check-input" type="radio" name="ship" id="shipFree" checked>
                        <label class="form-check-label w-100 d-flex justify-content-between" for="shipFree">
                            <span>FREE SHIP</span><span class="fw-semibold">MIỄN PHÍ</span>
                        </label>
                    </div>
                </div>

                <div class="mt-4">
                    <h4 class="mb-3">Thanh toán</h4>
                    <div class="form-check border rounded-3 p-3 border-muted mb-2">
                        <input class="form-check-input" type="radio" name="payment" id="cod" value="COD" checked>
                        <label class="form-check-label w-100" for="cod">
                            <span class="fw-semibold">Thanh toán khi nhận hàng (COD)</span>
                            <div class="small muted">Trả tiền cho đơn vị vận chuyển khi nhận hàng.</div>
                        </label>
                    </div>
                    <div class="form-check border rounded-3 p-3 border-muted">
                        <input class="form-check-input" type="radio" name="payment" id="bank" value="BANK">
                        <label class="form-check-label" for="bank">Chuyển khoản ngân hàng</label>
                    </div>
                </div>

                <div class="mt-4">
                    <div class="form-check border rounded-3 p-3 border-muted">
                        <input class="form-check-input" type="checkbox" id="sameaddr" checked>
                        <label class="form-check-label" for="sameaddr">Địa chỉ thanh toán giống địa chỉ giao hàng</label>
                    </div>
                </div>

                <div class="mt-4 d-grid">
                    <button class="btn btn-brand btn-lg"><i class="bi bi-bag-check me-2"></i>Đặt hàng</button>
                </div>

                <div class="mt-3 tiny">
                    <a class="text-decoration-none" href="javascript:history.back()"><i class="bi bi-arrow-left-short"></i> Quay lại</a>
                    <span class="mx-2">•</span>
                    <a class="text-decoration-none" th:if="${!buyNow}" th:href="@{/}">Tiếp tục mua sắm</a>
                </div>
            </form>
        </div>

        <!-- =================== SUMMARY =================== -->
        <div class="col-lg-5">
            <div class="border rounded-3 p-3 border-muted shadow-s">
                <h4 class="mb-3">Đơn hàng</h4>

                <!-- CART MODE -->
                <div th:if="${!buyNow}">
                    <div th:if="${#lists.isEmpty(items)}" class="alert alert-warning py-2">
                        Giỏ hàng trống. <a th:href="@{/}" class="alert-link">Quay lại mua sắm</a>.
                    </div>
                    <div th:each="i : ${items}" class="d-flex align-items-center justify-content-between mb-3">
                        <div class="d-flex align-items-center gap-2">
                            <img class="summary-img" th:src="@{'/photos/' + ${i.sanPham.hinhAnh}}" th:alt="${i.sanPham.tenSP}">
                            <div>
                                <div class="small fw-semibold text-truncate" style="max-width:260px" th:text="${i.sanPham.tenSP}">Tên</div>
                                <div class="small muted" th:text="'x' + ${i.soLuong}">x1</div>
                            </div>
                        </div>
                        <div class="fw-semibold" th:text="${#numbers.formatDecimal(i.donGia*i.soLuong,0,'POINT',0,'COMMA')} + 'đ'">0đ</div>
                    </div>
                </div>

                <!-- BUY-NOW MODE -->
                <div th:if="${buyNow}">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div class="d-flex align-items-center gap-2">
                            <img class="summary-img" th:src="@{'/photos/' + ${bnItem.sanPham.hinhAnh}}" th:alt="${bnItem.sanPham.tenSP}">
                            <div>
                                <div class="small fw-semibold text-truncate" style="max-width:260px" th:text="${bnItem.sanPham.tenSP}">Tên</div>
                                <div class="small muted" th:text="'x' + ${bnItem.soLuong}">x1</div>
                            </div>
                        </div>
                        <div class="fw-semibold" th:text="${#numbers.formatDecimal(bnItem.donGia*bnItem.soLuong,0,'POINT',0,'COMMA')} + 'đ'">0đ</div>
                    </div>
                    <div class="tiny muted"><i class="bi bi-lightning-charge-fill text-warning me-1"></i>Mua nhanh — không thêm vào giỏ hàng.</div>
                </div>

                <hr>
                <div class="d-flex justify-content-between">
                    <span class="muted">Tổng phụ</span>
                    <span th:text="${#numbers.formatDecimal(subtotal,0,'POINT',0,'COMMA')} + 'đ'">0đ</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span class="muted">Vận chuyển</span>
                    <span class="fw-semibold">MIỄN PHÍ</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="fw-semibold">Tổng</span>
                    <span class="h5 text-danger m-0" th:text="${#numbers.formatDecimal(total,0,'POINT',0,'COMMA')} + 'đ'">0đ</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Offcanvas CART (để nút Giỏ hàng trên header mở được) -->
<div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="cartOffcanvas" aria-labelledby="cartLabel">
    <div class="offcanvas-header border-bottom border-secondary">
        <h5 class="offcanvas-title fw-bold" id="cartLabel"><i class="bi bi-cart3 me-2 text-danger"></i>Giỏ hàng</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column">
        <div id="cartAlert" class="alert alert-success py-2 px-3 d-none">
            <i class="bi bi-check2-circle me-1"></i> Đã thêm vào giỏ.
        </div>
        <div id="cartBody" class="flex-grow-1">
            <p class="text-muted text-center my-4">Giỏ hàng trống</p>
        </div>
        <div class="border-top border-secondary pt-3 mt-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-semibold">Tổng phụ</span>
                <span class="fw-bold text-danger" id="cartSubtotal">0đ</span>
            </div>
            <div class="d-grid gap-2">
                <button class="btn btn-danger btn-lg" onclick="goCheckout()">
                    <i class="bi bi-credit-card me-2"></i>Thanh toán
                </button>
                <button class="btn btn-outline-light" onclick="clearCart()">
                    <i class="bi bi-trash3 me-2"></i>Xoá tất cả
                </button>
            </div>
            <small class="text-muted d-block mt-2">Phí & thuế tính ở bước sau.</small>
        </div>
    </div>
</div>

<!-- Footer -->
<div th:replace="~{layout/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- file JS chung (giỏ hàng, buy-now, …) -->
<script th:src="@{/js/main.js}"></script>
</body>
</html>
